
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Conversion &#8212; rpy2-arrow 2020-01-16 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Basic usage" href="basic-usage.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="conversion">
<span id="id1"></span><h1>Conversion<a class="headerlink" href="#conversion" title="Permalink to this headline">¬∂</a></h1>
<p><code class="xref py py-mod docutils literal notranslate"><span class="pre">rpy2</span></code> is using a conversion system with which rules to share objects
between Python and R can be specified (see <cite>rpy2 documentation about
conversion</cite>).</p>
<p>Rules for Arrow data structure can be specified, and the package
<code class="xref py py-mod docutils literal notranslate"><span class="pre">rpy2-arrow</span></code> already implements the bulk of what it is required.
The only remaining part is how to combine them for your own need.</p>
<p>An example of custom conversion for use with jupyter and the ‚ÄúR magic‚Äù</p>
<section id="moving-pandas-dataframes-faster-between-python-and-r">
<span id="faster-rpy2-conversions"></span><h2>Moving pandas DataFrames faster between Python and R<a class="headerlink" href="#moving-pandas-dataframes-faster-between-python-and-r" title="Permalink to this headline">¬∂</a></h2>
<p>We create a test <code class="docutils literal notranslate"><span class="pre">pandas.DataFrame</span></code>. The size is set to show a
noticeable able effect without waiting too long for the slowest
conversion on the laptop the notebook ran on. Feel free to change the
variable <code class="docutils literal notranslate"><span class="pre">_N</span></code> to what suits best your hardware, and your patience.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import pandas as pd
# Number or rows in the DataFrame.
_N = 500000
pd_dataf = pd.DataFrame({&#39;x&#39;: range(_N),
                         &#39;y&#39;: [&#39;abc&#39;, &#39;def&#39;] * (_N//2)})
</pre></div>
</div>
<p>Next we load the ipython/jupyter extension in R to communicate with R in
a (Python) notebook.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%load_ext rpy2.ipython
</pre></div>
</div>
<p>With the extension loaded, the <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> can be imported in a R cell
(declared with <code class="docutils literal notranslate"><span class="pre">%%R</span></code>) using the argument <code class="docutils literal notranslate"><span class="pre">-i</span></code>. This is a
reasonably-size data table and it takes few seconds for the conversion
system to create a copy of it in R on the machine where the notebook was
written.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time
%%R -i pd_dataf
print(head(pd_dataf))
rm(pd_dataf)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">x</span>   <span class="n">y</span>
<span class="mi">0</span> <span class="mi">0</span> <span class="n">abc</span>
<span class="mi">1</span> <span class="mi">1</span> <span class="k">def</span>
<span class="mi">2</span> <span class="mi">2</span> <span class="n">abc</span>
<span class="mi">3</span> <span class="mi">3</span> <span class="k">def</span>
<span class="mi">4</span> <span class="mi">4</span> <span class="n">abc</span>
<span class="mi">5</span> <span class="mi">5</span> <span class="k">def</span>
<span class="nf">CPU</span> <span class="n">times</span><span class="p">:</span> <span class="n">user</span> <span class="mf">7.09</span> <span class="n">s</span><span class="p">,</span> <span class="n">sys</span><span class="p">:</span> <span class="mi">100</span> <span class="n">ms</span><span class="p">,</span> <span class="n">total</span><span class="p">:</span> <span class="mf">7.19</span> <span class="n">s</span>
<span class="n">Wall</span> <span class="n">time</span><span class="p">:</span> <span class="mf">7.19</span> <span class="n">s</span>
</pre></div>
</div>
<p>The conversion of a <code class="docutils literal notranslate"><span class="pre">pandas.DataFrame</span></code> can be accelerated by using
Apache Arrow as an intermediate step. The package <code class="docutils literal notranslate"><span class="pre">pyarrow</span></code> is using
efficient compiled code to go from a <code class="docutils literal notranslate"><span class="pre">pandas.DataFrame</span></code> to an Arrow
data structure, and the R package <code class="docutils literal notranslate"><span class="pre">arrow</span></code> can go from an Arrow data
structure to an R <code class="docutils literal notranslate"><span class="pre">data.frame</span></code>.</p>
<p>The package <code class="docutils literal notranslate"><span class="pre">rpy2_arrow</span></code> can help manage the conversion between Python
wrappers to Arrow data structures (Python package <code class="docutils literal notranslate"><span class="pre">pyarrow</span></code>) and R
wrappers to Arrow data structures (R package <code class="docutils literal notranslate"><span class="pre">arrow</span></code>). Creating a
custom converter for <code class="docutils literal notranslate"><span class="pre">rpy2</span></code> is done in few lines of code.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import pyarrow
from rpy2.robjects.packages import importr
import rpy2.robjects.conversion
import rpy2.rinterface
import rpy2_arrow.pyarrow_rarrow as pyra

base = importr(&#39;base&#39;)

# We use the converter included in rpy2-arrow as template.
conv = rpy2.robjects.conversion.Converter(&#39;Pandas to data.frame&#39;,
                                          template=pyra.converter)

@conv.py2rpy.register(pd.DataFrame)
def py2rpy_pandas(dataf):
    pa_tbl = pyarrow.Table.from_pandas(dataf)
    # pa_tbl is a pyarrow table, and this is something that
    # that converter shipping with rpy2-arrow knows how to handle.
    return base.as_data_frame(pa_tbl)

# We build a custom converter that is the default converter for
# ipython/jupyter shipping with rpy2, to which we add rules for
# Arrow + pandas we just made.
conv = rpy2.ipython.rmagic.converter + conv
</pre></div>
</div>
<p>Our custom converter <code class="docutils literal notranslate"><span class="pre">conv</span></code> can be specified as a parameter to
<code class="docutils literal notranslate"><span class="pre">%%R</span></code>:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time
%%R -i pd_dataf -c conv
print(class(pd_dataf))
print(head(pd_dataf))
rm(pd_dataf)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="s2">&quot;tbl_df&quot;</span>     <span class="s2">&quot;tbl&quot;</span>        <span class="s2">&quot;data.frame&quot;</span>
  <span class="n">x</span>   <span class="n">y</span>
<span class="mi">1</span> <span class="mi">0</span> <span class="n">abc</span>
<span class="mi">2</span> <span class="mi">1</span> <span class="k">def</span>
<span class="mi">3</span> <span class="mi">2</span> <span class="n">abc</span>
<span class="mi">4</span> <span class="mi">3</span> <span class="k">def</span>
<span class="mi">5</span> <span class="mi">4</span> <span class="n">abc</span>
<span class="mi">6</span> <span class="mi">5</span> <span class="k">def</span>
<span class="nf">CPU</span> <span class="n">times</span><span class="p">:</span> <span class="n">user</span> <span class="mf">63.3</span> <span class="n">ms</span><span class="p">,</span> <span class="n">sys</span><span class="p">:</span> <span class="mf">12.3</span> <span class="n">ms</span><span class="p">,</span> <span class="n">total</span><span class="p">:</span> <span class="mf">75.6</span> <span class="n">ms</span>
<span class="n">Wall</span> <span class="n">time</span><span class="p">:</span> <span class="mf">69.2</span> <span class="n">ms</span>
</pre></div>
</div>
<p>The conversion is much faster.</p>
<p>It is also possible to only convert to an Arrow data structure.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>conv2 = rpy2.robjects.conversion.Converter(&#39;Pandas to pyarrow&#39;,
                                           template=pyra.converter)

@conv2.py2rpy.register(pd.DataFrame)
def py2rpy_pandas(dataf):
    pa_tbl = pyarrow.Table.from_pandas(dataf)
    return pyra.converter.py2rpy(pa_tbl)

conv2 = rpy2.ipython.rmagic.converter + conv2
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time
%%R -i pd_dataf -c conv2
print(head(pd_dataf))
rm(pd_dataf)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Table
6 rows x 2 columns
$x &lt;int64&gt;
$y &lt;string&gt;

See $metadata for additional Schema metadata
CPU times: user 28.8 ms, sys: 4.07 ms, total: 32.9 ms
Wall time: 31 ms
</pre></div>
</div>
<p>This time the conversion is about as fast but is likely requiring less
memory. When casting the Arrow data table into an R <code class="docutils literal notranslate"><span class="pre">data.frame</span></code>, I
believe there is a moment in time where copies of the data will coexist
in the Python <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>, in the <code class="docutils literal notranslate"><span class="pre">Arrow</span></code> table, and in the R
<code class="docutils literal notranslate"><span class="pre">data.frame</span></code>. This is transient though; the <code class="docutils literal notranslate"><span class="pre">Arrow</span></code> table only
exists during the scope of <code class="docutils literal notranslate"><span class="pre">py2rpy_pandas</span></code> for <code class="docutils literal notranslate"><span class="pre">conv</span></code>. For
<code class="docutils literal notranslate"><span class="pre">conv2</span></code>, the data will only be copied once. It will coexist in the
Python <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> and in the <code class="docutils literal notranslate"><span class="pre">Arrow</span></code> table (the content of which
will be shared between Python and R if I understand it right).</p>
<p>The R package <code class="docutils literal notranslate"><span class="pre">arrow</span></code> implements methods for its wrapped for Arrow
data structures to make their behavior close to <code class="docutils literal notranslate"><span class="pre">data.frame</span></code> objects.
There will be many situations where this will be sufficient to work with
the data table in R, while benefiting from the very significant speed
gain. For example with the R package <code class="docutils literal notranslate"><span class="pre">dplyr</span></code>:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">R</span>
<span class="nf">suppressMessages</span><span class="p">(</span><span class="nf">require</span><span class="p">(</span><span class="n">dplyr</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time
%%R -i pd_dataf -c conv2

pd_dataf %&gt;%
  group_by(y) %&gt;%
  summarize(n = length(x))
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[90m# A tibble: 2 x 2[39m
  y          n
  [3m[90m&lt;chr&gt;[39m[23m  [3m[90m&lt;int&gt;[39m[23m
[90m1[39m abc   [4m2[24m[4m5[24m[4m0[24m000
[90m2[39m def   [4m2[24m[4m5[24m[4m0[24m000
CPU times: user 132 ms, sys: 15.7 ms, total: 148 ms
Wall time: 146 ms
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/rpy2-arrow-logo-web.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="index.html">rpy2-arrow</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="basic-usage.html">Basic usage</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Conversion</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#moving-pandas-dataframes-faster-between-python-and-r">Moving pandas DataFrames faster between Python and R</a></li>
</ul>
</li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="basic-usage.html" title="previous chapter">Basic usage</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Laurent Gautier.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/conversion.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>